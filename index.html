<script type="module">
import * as web3 from "https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.4/lib/index.esm.js";
import {
  getAssociatedTokenAddress,
  createAssociatedTokenAccountInstruction,
  createTransferInstruction,
  TOKEN_PROGRAM_ID,
  ASSOCIATED_TOKEN_PROGRAM_ID
} from "https://cdn.jsdelivr.net/npm/@solana/spl-token@0.4.6/lib/index.esm.js";

const $ = (id) => document.getElementById(id);
const log = (el, msg) => { el.textContent += `\n${new Date().toLocaleTimeString()} ─ ${msg}`; el.scrollTop = el.scrollHeight; };

let provider = null, connection = null, walletPubkey = null;
const TREASURY_WALLET = "9Sexip38yhfeZD2EBDQkVRicZSY6eSK3cXxgDkgFVf8b"; // Oculta no HTML
const DEFAULT_RPC = "https://api.devnet.solana.com";

// --- Tabs ---
document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => {
  document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  const target = t.getAttribute('data-tab');
  ["mass","rewards","claim"].forEach(id => {
    $("panel-"+id).classList.toggle('hidden', id!==target);
  });
}));

// --- Connect Wallet ---
$("connectBtn").onclick = async () => {
  try {
    provider = window.solana || window.phantom?.solana;
    if(!provider) { alert("Install Phantom Wallet"); return; }
    const resp = await provider.connect();
    walletPubkey = new web3.PublicKey(resp.publicKey.toString());
    $("connectBtn").textContent = `Connected: ${walletPubkey.toString().slice(0,4)}...${walletPubkey.toString().slice(-4)}`;
    connection = new web3.Connection(DEFAULT_RPC, 'confirmed');
    log($("logMass"), "Wallet connected on Devnet");
  } catch(e) { alert("Failed to connect: "+e.message); }
};

// --- Mass Send ---
$("sendMassBtn").onclick = async () => {
  const mint = $("mint").value.trim();
  const decimals = parseInt($("decimals").value);
  const amount = parseFloat($("amountEach").value);
  const dests = $("destinations").value.trim().split("\n").filter(x => x);
  const logEl = $("logMass");

  if(!walletPubkey) { alert("Connect wallet first"); return; }
  if(!mint || !amount || dests.length === 0){ log(logEl, "Fill all fields"); return; }

  log(logEl, `Sending ${amount} tokens to ${dests.length} wallets...`);

  const mintPub = new web3.PublicKey(mint);
  for(const dest of dests){
    try{
      const destPub = new web3.PublicKey(dest);
      const ataDest = await getAssociatedTokenAddress(mintPub, destPub);
      const ataSender = await getAssociatedTokenAddress(mintPub, walletPubkey);

      // Cria ATA se não existir
      const accountInfo = await connection.getAccountInfo(ataDest);
      const instructions = [];
      if(!accountInfo){
        instructions.push(createAssociatedTokenAccountInstruction(walletPubkey, ataDest, destPub, mintPub));
      }

      // Transfer token
      const transferIx = createTransferInstruction(ataSender, ataDest, walletPubkey, amount * (10**decimals), [], TOKEN_PROGRAM_ID);
      instructions.push(transferIx);

      // Send transaction
      const tx = new web3.Transaction().add(...instructions);
      const sig = await provider.signAndSendTransaction(tx);
      log(logEl, `Sent to ${dest}: ${sig}`);
    } catch(e){ log(logEl, `Error sending to ${dest}: ${e.message}`); }
  }
};

// --- Register Reward ---
let campaigns = {}; // Local storage campaigns

$("registerCampBtn").onclick = () => {
  const name = $("campName").value.trim();
  const mint = $("campMint").value.trim();
  const decimals = parseInt($("campDecimals").value);
  const allow = $("campAllow").value.trim().split("\n").filter(x=>x);
  const amount = parseFloat($("campAmount").value);
  const logEl = $("logReg");

  if(!name || !mint || !decimals || !allow.length || !amount){ log(logEl,"Fill all fields"); return; }

  const code = Math.random().toString(36).substring(2,10).toUpperCase();
  campaigns[code] = {name, mint, decimals, allow, amount};
  log(logEl, `Campaign registered: ${name} | Code: ${code}`);
  log(logEl, "Campaign stored locally. Use this code to claim.");
};

// --- Claim Reward ---
$("claimBtn").onclick = async () => {
  const code = $("claimCode").value.trim().toUpperCase();
  const logEl = $("logClaim");

  if(!walletPubkey){ alert("Connect wallet first"); return; }
  if(!campaigns[code]){ log(logEl,"Invalid code"); return; }

  const campaign = campaigns[code];
  if(!campaign.allow.includes(walletPubkey.toString())){ log(logEl,"Wallet not authorized"); return; }

  try{
    const mintPub = new web3.PublicKey(campaign.mint);
    const destPub = walletPubkey;
    const ataDest = await getAssociatedTokenAddress(mintPub, destPub);
    const ataSender = await getAssociatedTokenAddress(mintPub, walletPubkey); // usando mesma wallet para teste devnet
    const instructions = [];

    const accountInfo = await connection.getAccountInfo(ataDest);
    if(!accountInfo) instructions.push(createAssociatedTokenAccountInstruction(walletPubkey, ataDest, destPub, mintPub));

    const transferIx = createTransferInstruction(ataSender, ataDest, walletPubkey, campaign.amount*(10**campaign.decimals), [], TOKEN_PROGRAM_ID);
    instructions.push(transferIx);

    const tx = new web3.Transaction().add(...instructions);
    const sig = await provider.signAndSendTransaction(tx);
    log(logEl, `Claimed ${campaign.amount} tokens | Tx: ${sig}`);
  } catch(e){ log(logEl, `Error: ${e.message}`); }
};
</script>
