<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>TurboTuga Mass Sender</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background: #0f172a; font-family: 'Inter', sans-serif; color: #f1f5f9; }
.card { background: rgba(30,41,59,.85); border-radius: 1rem; padding: 1.5rem; border: 1px solid rgba(255,255,255,.1); }
.input, select, textarea { width: 100%; padding: .5rem; border-radius: .75rem; border: 1px solid rgba(255,255,255,.2); background: #1e293b; color: #f1f5f9; }
textarea { resize: vertical; min-height: 120px; }
.btn { padding: .5rem 1rem; border-radius: .75rem; background: #4f46e5; color: #fff; cursor: pointer; transition: .2s; }
.btn:hover { background: #6366f1; }
.btn-danger { background: #dc2626; }
.log { background: rgba(0,0,0,.4); padding: .5rem; border-radius: .5rem; font-family: monospace; max-height: 200px; overflow:auto; }
</style>
</head>
<body>
<div class="max-w-4xl mx-auto p-6 space-y-6">
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold">TurboTuga Mass Sender</h1>
    <div class="space-x-2">
      <button id="connectBtn" class="btn">Connect Wallet</button>
      <button id="disconnectBtn" class="btn btn-danger hidden">Disconnect</button>
    </div>
  </div>

  <div class="card space-y-4">
    <div>
      <label>RPC (optional)</label>
      <input id="rpcUrl" class="input" placeholder="Leave empty to auto-detect network">
    </div>

    <div>
      <label>Paste Token Mint (optional, overrides wallet tokens)</label>
      <input id="mintInput" class="input" placeholder="e.g. So11111111111111111111111111111111111111112">
    </div>

    <div>
      <label>Select SPL Token from Wallet</label>
      <select id="tokenSelect" class="input">
        <option value="">— connect wallet to load tokens —</option>
      </select>
      <div id="tokenInfo" class="text-sm text-gray-300 mt-1"></div>
    </div>

    <div>
      <label>Amount per Wallet</label>
      <input id="amountEach" type="number" step="any" placeholder="e.g. 10" class="input">
    </div>

    <div>
      <label>Destination Wallets (one per line)</label>
      <textarea id="destinations" class="input"></textarea>
      <div class="mt-2 flex items-center gap-2">
        <input type="file" id="fileInput" class="hidden">
        <button id="uploadBtn" class="btn">Upload .txt or .csv</button>
      </div>
    </div>

    <div>
      <label>Fee per wallet</label>
      <input type="text" class="input" value="0.00005 SOL per wallet" readonly>
    </div>

    <div class="flex space-x-2">
      <button id="calcBtn" class="btn">Calculate Fee</button>
      <button id="sendBtn" class="btn" disabled>Send</button>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <pre id="calcLog" class="log"></pre>
      <pre id="runLog" class="log"></pre>
    </div>
  </div>
</div>

<script type="module">
import * as solanaWeb3 from "https://esm.sh/@solana/web3.js@1.95.4";
import {
  getAssociatedTokenAddress,
  createAssociatedTokenAccountInstruction,
  createTransferInstruction,
  TOKEN_PROGRAM_ID,
  ASSOCIATED_TOKEN_PROGRAM_ID
} from "https://esm.sh/@solana/spl-token@0.4.6";

const $=(id)=>document.getElementById(id);
const FEE_PER_RECIPIENT_SOL=0.00005;
let provider=null, connection=null, walletPubkey=null;
let tokenList=[], selectedToken=null;

const connectBtn=$("connectBtn"), disconnectBtn=$("disconnectBtn");
const tokenSelect=$("tokenSelect"), tokenInfo=$("tokenInfo");
const calcBtn=$("calcBtn"), sendBtn=$("sendBtn");
const calcLog=$("calcLog"), runLog=$("runLog");

// Connect wallet
connectBtn.onclick=async()=>{
  if(!window.solana) return alert("Please install Phantom Wallet");
  provider=window.solana;
  try{
    const resp=await provider.connect({onlyIfTrusted:false});
    walletPubkey=resp.publicKey;
    connectBtn.classList.add("hidden"); 
    disconnectBtn.classList.remove("hidden");

    // Detect network automatically
    const network=await provider.request({method:"getCluster"});
    const rpcInput=$("rpcUrl").value.trim();
    let rpcUrl=rpcInput;
    if(!rpcInput){
      rpcUrl = network==="mainnet-beta" ? solanaWeb3.clusterApiUrl("mainnet-beta") : solanaWeb3.clusterApiUrl("devnet");
    }
    connection=new solanaWeb3.Connection(rpcUrl,"confirmed");
    await loadTokens();
  }catch(e){ alert("Error: "+e.message);}
};

// Disconnect wallet
disconnectBtn.onclick=()=>{
  provider=null; walletPubkey=null; tokenList=[]; selectedToken=null;
  tokenSelect.innerHTML=`<option value="">— connect wallet to load tokens —</option>`;
  tokenInfo.textContent="";
  connectBtn.classList.remove("hidden"); 
  disconnectBtn.classList.add("hidden");
  sendBtn.disabled=true; calcLog.textContent=""; runLog.textContent="";
};

// File upload
$("uploadBtn").onclick=()=>$("fileInput").click();
$("fileInput").addEventListener("change", async(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const text=await f.text();
  const wallets=text.replace(/\r/g,"\n").split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  $("destinations").value=wallets.join("\n");
});

// Load SPL tokens
async function loadTokens(){
  tokenSelect.innerHTML=`<option>Loading...</option>`;
  try{
    const resp=await connection.getParsedTokenAccountsByOwner(walletPubkey,{programId:TOKEN_PROGRAM_ID});
    tokenList=[];
    if(!resp.value || resp.value.length===0){
      tokenSelect.innerHTML=`<option>No tokens found</option>`; return;
    }
    for(const {account} of resp.value){
      const info=account.data.parsed.info;
      const ui=Number(info.tokenAmount.uiAmountString||0);
      if(ui>0) tokenList.push({mint:info.mint, decimals:info.tokenAmount.decimals, amount:ui});
    }
    if(tokenList.length===0){
      tokenSelect.innerHTML=`<option>No tokens with balance</option>`; tokenInfo.textContent=""; return;
    }
    tokenSelect.innerHTML=`<option value="">— select —</option>`+
      tokenList.map((t,i)=>`<option value="${i}">${t.mint.slice(0,6)}…${t.mint.slice(-6)} • ${t.amount}</option>`).join("");
    tokenSelect.onchange=()=>{
      const idx=tokenSelect.value;
      if(idx===""){ selectedToken=null; tokenInfo.textContent=""; sendBtn.disabled=true; return; }
      selectedToken=tokenList[idx];
      tokenInfo.textContent=`Mint: ${selectedToken.mint} | Balance: ${selectedToken.amount}`;
      sendBtn.disabled=false;
    };
  }catch(e){ tokenSelect.innerHTML=`<option>Error loading tokens</option>`; tokenInfo.textContent=e.message; }
}

// Validate Solana address
function isValidSolAddress(addr){ try{new solanaWeb3.PublicKey(addr); return true}catch{return false;} }

// Calculate fee
calcBtn.onclick=async()=>{
  calcLog.textContent="";
  const mintInput=$("mintInput").value.trim();
  if(mintInput==="" && !selectedToken){ calcLog.textContent="Select a token or paste a mint."; return; }
  const dests=$("destinations").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const invalid=dests.filter(d=>!isValidSolAddress(d));
  if(invalid.length>0){ calcLog.textContent=`Invalid addresses:\n${invalid.join("\n")}`; sendBtn.disabled=true; return; }
  const fee=FEE_PER_RECIPIENT_SOL*dests.length;
  const balance=await connection.getBalance(walletPubkey)/solanaWeb3.LAMPORTS_PER_SOL;
  calcLog.textContent=`Recipients: ${dests.length}\nNetwork fee: ${fee.toFixed(6)} SOL\nWallet balance: ${balance.toFixed(6)} SOL`;
  sendBtn.disabled=(balance<fee);
};

// Send tokens
sendBtn.onclick=async()=>{
  runLog.textContent="Sending…\n";
  const dests=$("destinations").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const amt=Number($("amountEach").value);
  let mintStr=$("mintInput").value.trim();
  let decimals=0;
  let mint;
  if(mintStr!==""){
    mint=new solanaWeb3.PublicKey(mintStr);
    decimals=9; // default, could fetch actual decimals
  } else if(selectedToken){
    mint=new solanaWeb3.PublicKey(selectedToken.mint);
    decimals=selectedToken.decimals;
  } else { runLog.textContent="No token selected"; return; }

  let sentCount=0;
  for(const dest of dests){
    try{
      const destPk=new solanaWeb3.PublicKey(dest);
      const ataFrom=await getAssociatedTokenAddress(mint,walletPubkey);
      const ataTo=await getAssociatedTokenAddress(mint,destPk);
      const instrs=[];
      const resp=await connection.getAccountInfo(ataTo);
      if(!resp) instrs.push(createAssociatedTokenAccountInstruction(walletPubkey,destPk,mint,walletPubkey, ASSOCIATED_TOKEN_PROGRAM_ID, TOKEN_PROGRAM_ID));
      instrs.push(createTransferInstruction(ataFrom,ataTo,walletPubkey,amt*Math.pow(10,decimals),[],TOKEN_PROGRAM_ID));
      const tx=new solanaWeb3.Transaction().add(...instrs);
      const sig=await provider.signAndSendTransaction(tx);
      runLog.textContent+=`✅ ${dest} sent: ${sig}\n`; sentCount++;
    }catch(e){ runLog.textContent+=`❌ ${dest} failed: ${e.message}\n`; }
  }
  runLog.textContent+=`\nCompleted: ${sentCount}/${dests.length}`;
};
</script>
</body>
</html>
