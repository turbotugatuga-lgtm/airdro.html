<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>TurboTuga Mass Sender Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@solana/web3.js@1.95.4/lib/index.iife.js"></script>
<script src="https://unpkg.com/@solana/spl-token@0.4.6/lib/index.iife.js"></script>
<style>
body { background: #0f172a; font-family: 'Inter', sans-serif; color: #f1f5f9; }
.card { background: rgba(30,41,59,.85); border-radius: 1rem; padding: 1.5rem; border: 1px solid rgba(255,255,255,.1); }
.input, select, textarea { width: 100%; padding: .5rem; border-radius: .75rem; border: 1px solid rgba(255,255,255,.2); background: #1e293b; color: #f1f5f9; }
textarea { resize: vertical; min-height: 120px; }
.btn { padding: .5rem 1rem; border-radius: .75rem; background: #4f46e5; color: #fff; cursor: pointer; transition: .2s; }
.btn:hover { background: #6366f1; }
.btn-danger { background: #dc2626; }
.log { background: rgba(0,0,0,.4); padding: .5rem; border-radius: .5rem; font-family: monospace; max-height: 200px; overflow:auto; }
</style>
</head>
<body>
<div class="max-w-4xl mx-auto p-6 space-y-6">
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold">TurboTuga Mass Sender</h1>
    <div class="space-x-2">
      <button id="connectBtn" class="btn">Conectar carteira</button>
      <button id="disconnectBtn" class="btn btn-danger hidden">Desconectar</button>
    </div>
  </div>

  <div class="card space-y-4">
    <div>
      <label>RPC (opcional)</label>
      <input id="rpcUrl" class="input" placeholder="ex.: https://api.mainnet-beta.solana.com">
    </div>

    <div>
      <label>Selecione token SPL</label>
      <select id="tokenSelect" class="input"></select>
      <div id="tokenInfo" class="text-sm text-gray-300 mt-1"></div>
    </div>

    <div>
      <label>Quantidade por carteira</label>
      <input id="amountEach" type="number" step="any" placeholder="ex.: 10" class="input">
    </div>

    <div>
      <label>Carteiras de destino (uma por linha)</label>
      <textarea id="destinations" class="input"></textarea>
      <div class="mt-2 flex items-center gap-2">
        <input type="file" id="fileInput" class="hidden">
        <button id="uploadBtn" class="btn">Upload .txt ou .csv</button>
      </div>
    </div>

    <div>
      <label>Taxa por carteira</label>
      <input type="text" class="input" value="0.00005 SOL por carteira" readonly>
    </div>

    <div class="flex space-x-2">
      <button id="calcBtn" class="btn">Calcular taxa</button>
      <button id="sendBtn" class="btn" disabled>Enviar</button>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <pre id="calcLog" class="log"></pre>
      <pre id="runLog" class="log"></pre>
    </div>
  </div>
</div>

<script>
const $=(id)=>document.getElementById(id);
const TREASURY="9Sexip38yhfeZD2EBDQkVRicZSY6eSK3cXxgDkgFVf8b";
const FEE_PER_RECIPIENT_SOL=0.00005;
let provider=null, connection=null, walletPubkey=null;
let tokenList=[], selectedToken=null;

const connectBtn=$("connectBtn"), disconnectBtn=$("disconnectBtn");
const tokenSelect=$("tokenSelect"), tokenInfo=$("tokenInfo");
const calcBtn=$("calcBtn"), sendBtn=$("sendBtn");
const calcLog=$("calcLog"), runLog=$("runLog");

connectBtn.onclick=async()=>{
  if(!window.solana) return alert("Instale Phantom Wallet");
  provider=window.solana;
  try{
    const resp=await provider.connect({onlyIfTrusted:false}); // força login manual
    walletPubkey=resp.publicKey;
    connectBtn.classList.add("hidden"); 
    disconnectBtn.classList.remove("hidden");
    const rpc=$("rpcUrl").value.trim();
    connection=new solanaWeb3.Connection(rpc||solanaWeb3.clusterApiUrl("devnet"),"confirmed");
    await loadTokens();
  }catch(e){ alert("Falha: "+e.message);}
};

disconnectBtn.onclick=async()=>{
  provider=null; walletPubkey=null; tokenList=[]; selectedToken=null;
  tokenSelect.innerHTML=`<option value="">— conecte para carregar tokens —</option>`;
  tokenInfo.textContent="";
  connectBtn.classList.remove("hidden"); 
  disconnectBtn.classList.add("hidden");
  sendBtn.disabled=true; calcLog.textContent=""; runLog.textContent="";
};

$("uploadBtn").onclick=()=>$("fileInput").click();
$("fileInput").addEventListener("change", async(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const text=await f.text();
  const wallets=text.replace(/\r/g,"\n").split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
  $("destinations").value=wallets.join("\n");
});

async function loadTokens(){
  tokenSelect.innerHTML=`<option>Carregando...</option>`;
  try{
    const resp=await connection.getParsedTokenAccountsByOwner(walletPubkey,{programId:splToken.TOKEN_PROGRAM_ID});
    tokenList=[];
    for(const {account} of resp.value){
      const info=account.data.parsed.info;
      const ui=Number(info.tokenAmount.uiAmountString||0);
      if(ui>0) tokenList.push({mint:info.mint, decimals:info.tokenAmount.decimals, amount:ui});
    }
    if(tokenList.length===0){ tokenSelect.innerHTML=`<option>Nenhum token com saldo</option>`; tokenInfo.textContent=""; return; }
    tokenSelect.innerHTML=`<option value="">— selecione —</option>`+tokenList.map((t,i)=>`<option value="${i}">${t.mint.slice(0,6)}…${t.mint.slice(-6)} • ${t.amount}</option>`).join("");
    tokenSelect.onchange=()=>{
      const idx=tokenSelect.value;
      if(idx===""){ selectedToken=null; tokenInfo.textContent=""; return; }
      selectedToken=tokenList[idx];
      tokenInfo.textContent=`Mint: ${selectedToken.mint} | Saldo: ${selectedToken.amount}`;
      sendBtn.disabled=false;
    };
  }catch(e){ tokenSelect.innerHTML=`<option>Erro</option>`; tokenInfo.textContent=e.message; }
}

function isValidSolAddress(addr){ try{new solanaWeb3.PublicKey(addr); return true}catch{return false;} }

calcBtn.onclick=async()=>{
  calcLog.textContent="";
  if(!selectedToken){ calcLog.textContent="Selecione um token."; return; }
  const dests=$("destinations").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const invalid=dests.filter(d=>!isValidSolAddress(d));
  if(invalid.length>0){ calcLog.textContent=`Carteiras inválidas:\n${invalid.join("\n")}`; sendBtn.disabled=true; return; }
  const fee=FEE_PER_RECIPIENT_SOL*dests.length;
  const balance=await connection.getBalance(walletPubkey)/solanaWeb3.LAMPORTS_PER_SOL;
  calcLog.textContent=`Destinatários: ${dests.length}\nTaxa rede: ${fee.toFixed(6)} SOL\nSaldo: ${balance.toFixed(6)} SOL`;
  sendBtn.disabled=(balance<fee);
};

sendBtn.onclick=async()=>{
  runLog.textContent="Enviando…\n";
  const dests=$("destinations").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const amt=Number($("amountEach").value);
  const decimals=selectedToken.decimals;
  const mint=new solanaWeb3.PublicKey(selectedToken.mint);
  let sentCount=0;
  for(const dest of dests){
    try{
      const destPk=new solanaWeb3.PublicKey(dest);
      const ataFrom=await splToken.getAssociatedTokenAddress(mint,walletPubkey);
      const ataTo=await splToken.getAssociatedTokenAddress(mint,destPk);
      const instrs=[];
      const resp=await connection.getAccountInfo(ataTo);
      if(!resp) instrs.push(splToken.createAssociatedTokenAccountInstruction(walletPubkey,destPk,mint,walletPubkey));
      instrs.push(splToken.createTransferInstruction(ataFrom,ataTo,walletPubkey,amt*Math.pow(10,decimals),[],splToken.TOKEN_PROGRAM_ID));
      const tx=new solanaWeb3.Transaction().add(...instrs);
      const sig=await solanaWeb3.sendAndConfirmTransaction(connection,tx,[provider]);
      runLog.textContent+=`✅ ${dest} enviado: ${sig}\n`; sentCount++;
    }catch(e){ runLog.textContent+=`❌ ${dest} falhou: ${e.message}\n`; }
  }
  runLog.textContent+=`\nEnvio concluído: ${sentCount}/${dests.length}`;
};
</script>
</body>
</html>

