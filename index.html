<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solana Airdrop Widget - Devnet</title>
<style>
:root{--bg:#0b1220;--panel:#101826;--muted:#90a3b5;--text:#e8f0ff;--accent:#7cc4ff;--ok:#34d399;--warn:#f59e0b;--err:#ef4444}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0a0f1c,#0d1220 40%,#0d1426);color:var(--text)}
.container{max-width:980px;margin:24px auto;padding:16px}
.card{background:rgba(16,24,38,.8);border:1px solid rgba(124,196,255,.15);backdrop-filter: blur(6px);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:18px}
h1{font-size:24px;margin:0 0 6px} h2{font-size:16px;color:var(--muted);font-weight:500;margin:0 0 18px}
.row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
.col{flex:1;min-width:260px}
input,textarea,select,button{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(124,196,255,.18);background:#0e1624;color:var(--text);outline:none}
textarea{min-height:120px;resize:vertical}
label{display:block;font-size:13px;color:var(--muted);margin:10px 4px}
.muted{color:var(--muted)} .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
.btn{cursor:pointer;border:1px solid rgba(124,196,255,.35)}
.btn:hover{filter:brightness(1.05)}
.tabs{display:flex;gap:8px;margin:12px 0 16px}
.tab{flex:1;text-align:center;padding:10px;border-radius:12px;border:1px solid rgba(124,196,255,.18);cursor:pointer;background:#0f1828}
.tab.active{background:#13233a;border-color:rgba(124,196,255,.4)}
.footer{font-size:12px;color:var(--muted);margin-top:18px;text-align:center}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(124,196,255,.25);background:#0b1526}
.hidden{display:none}
.small{font-size:12px}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Solana Airdrop Widget</h1>
    <h2>Devnet • Connect your wallet to test <span class="pill">Beta</span></h2>

    <div class="row">
      <div class="col" style="max-width:220px">
        <button class="btn" id="connectBtn">Connect Wallet</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="mass">Mass Send</div>
      <div class="tab" data-tab="rewards">Register Reward</div>
      <div class="tab" data-tab="claim">Claim Reward</div>
    </div>

    <!-- Mass Send Panel -->
    <div id="panel-mass">
      <div class="row">
        <div class="col">
          <label>Token Mint (SPL)</label>
          <input id="mint" class="mono" placeholder="So11111111111111111111111111111111111111112">
        </div>
        <div class="col">
          <label>Decimals</label>
          <input id="decimals" type="number" min="0" max="9" value="9">
        </div>
        <div class="col">
          <label>Amount per Wallet</label>
          <input id="amountEach" type="number" step="any" placeholder="10">
        </div>
      </div>
      <label>Recipient Wallets (one per line)</label>
      <textarea id="destinations" placeholder="3xe...abc\n7fD...xyz\n..."></textarea>
      <div class="row">
        <div class="col" style="max-width:220px">
          <button class="btn" id="sendMassBtn">Execute Mass Send</button>
        </div>
      </div>
      <div id="logMass" class="small muted mono"></div>
    </div>

    <!-- Register Reward Panel -->
    <div id="panel-rewards" class="hidden">
      <div class="row">
        <div class="col">
          <label>Campaign Name</label>
          <input id="campName" placeholder="My Campaign">
        </div>
        <div class="col">
          <label>Reward Token Mint</label>
          <input id="campMint" class="mono">
        </div>
        <div class="col">
          <label>Decimals</label>
          <input id="campDecimals" type="number" min="0" max="9" value="9">
        </div>
      </div>
      <label>Authorized Wallets (one per line)</label>
      <textarea id="campAllow" placeholder="Wallets allowed to claim"></textarea>
      <div class="row">
        <div class="col">
          <label>Amount per Claim</label>
          <input id="campAmount" type="number" step="any" placeholder="5">
        </div>
        <div class="col" style="max-width:220px">
          <button class="btn" id="registerCampBtn">Register Campaign</button>
        </div>
      </div>
      <div id="logReg" class="small muted mono"></div>
    </div>

    <!-- Claim Panel -->
    <div id="panel-claim" class="hidden">
      <div class="row">
        <div class="col">
          <label>Campaign Code</label>
          <input id="claimCode" placeholder="Paste code here">
        </div>
        <div class="col" style="max-width:220px">
          <button class="btn" id="claimBtn">Claim</button>
        </div>
      </div>
      <div id="logClaim" class="small muted mono"></div>
    </div>

    <div class="footer">Devnet only. All actions client-side.</div>
  </div>
</div>

<script type="module">
import * as web3 from "https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.4/lib/index.esm.js";
import {
  getAssociatedTokenAddress,
  createAssociatedTokenAccountInstruction,
  createTransferInstruction,
  TOKEN_PROGRAM_ID
} from "https://cdn.jsdelivr.net/npm/@solana/spl-token@0.4.6/lib/index.esm.js";

const $ = (id) => document.getElementById(id);
const log = (el, msg) => { el.textContent += `\n${new Date().toLocaleTimeString()} ─ ${msg}`; el.scrollTop = el.scrollHeight; };

let provider=null, connection=null, walletPubkey=null;
const TREASURY_WALLET = "HIDDEN"; // Oculta no HTML
const DEFAULT_RPC = "https://api.devnet.solana.com";

// --- Tabs ---
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const target = t.getAttribute('data-tab');
  ["mass","rewards","claim"].forEach(id=>{
    $("panel-"+id).classList.toggle('hidden', id!==target);
  });
}));

// --- Connect Wallet ---
$("connectBtn").onclick = async ()=>{
  try{
    provider = window.solana || window.phantom?.solana;
    if(!provider){ alert("Install Phantom Wallet"); return; }
    const resp = await provider.connect();
    walletPubkey = new web3.PublicKey(resp.publicKey.toString());
    $("connectBtn").textContent=`Connected: ${walletPubkey.toString().slice(0,4)}...${walletPubkey.toString().slice(-4)}`;
    connection = new web3.Connection(DEFAULT_RPC,'confirmed');
    log($("logMass"),"Wallet connected on Devnet");
  }catch(e){ alert("Failed to connect: "+e.message); }
};

// --- Mass Send ---
$("sendMassBtn").onclick = async ()=>{
  const mint = $("mint").value.trim();
  const decimals = parseInt($("decimals").value);
  const amount = parseFloat($("amountEach").value);
  const dests = $("destinations").value.trim().split("\n").filter(x=>x);
  const logEl = $("logMass");

  if(!walletPubkey){ alert("Connect wallet first"); return; }
  if(!mint || !amount || dests.length===0){ log(logEl,"Fill all fields"); return; }

  log(logEl, `Sending ${amount} tokens to ${dests.length} wallets...`);
  const mintPub = new web3.PublicKey(mint);
  const ataSender = await getAssociatedTokenAddress(mintPub, walletPubkey);

  for(const dest of dests){
    try{
      const destPub = new web3.PublicKey(dest);
      const ataDest = await getAssociatedTokenAddress(mintPub, destPub);

      const instructions = [];
      const info = await connection.getAccountInfo(ataDest);
      if(!info) instructions.push(createAssociatedTokenAccountInstruction(walletPubkey, ataDest, destPub, mintPub));

      const transferIx = createTransferInstruction(ataSender, ataDest, walletPubkey, amount*(10**decimals));
      instructions.push(transferIx);

      const tx = new web3.Transaction().add(...instructions);
      const sig = await provider.signAndSendTransaction(tx);
      log(logEl, `Sent to ${dest}: ${sig}`);
    }catch(e){ log(logEl,`Error sending to ${dest}: ${e.message}`);}
  }
};

// --- Register Reward ---
let campaigns = {};
$("registerCampBtn").onclick = ()=>{
  const name = $("campName").value.trim();
  const mint = $("campMint").value.trim();
  const decimals = parseInt($("campDecimals").value);
  const allow = $("campAllow").value.trim().split("\n").filter(x=>x);
  const amount = parseFloat($("campAmount").value);
  const logEl = $("logReg");

  if(!name || !mint || !decimals || !allow.length || !amount){ log(logEl,"Fill all fields"); return; }

  const code = Math.random().toString(36).substring(2,10).toUpperCase();
  campaigns[code] = {name,mint,decimals,allow,amount};
  log(logEl, `Campaign registered: ${name} | Code: ${code}`);
  log(logEl, "Stored locally for testing devnet.");
};

// --- Claim Reward ---
$("claimBtn").onclick = async ()=>{
  const code = $("claimCode").value.trim().toUpperCase();
  const logEl = $("logClaim");
  if(!walletPubkey){ alert("Connect wallet first"); return; }
  if(!campaigns[code]){ log(logEl,"Invalid code"); return; }
  const campaign = campaigns[code];
  if(!campaign.allow.includes(walletPubkey.toString())){ log(logEl,"Wallet not authorized"); return; }

  try{
    const mintPub = new web3.PublicKey(campaign.mint);
    const destPub = walletPubkey;
    const ataDest = await getAssociatedTokenAddress(mintPub,destPub);
    const ataSender = await getAssociatedTokenAddress(mintPub,walletPubkey);
    const instructions = [];

    const info = await connection.getAccountInfo(ataDest);
    if(!info) instructions.push(createAssociatedTokenAccountInstruction(walletPubkey, ataDest, destPub, mintPub));

    instructions.push(createTransferInstruction(ataSender, ataDest, walletPubkey, campaign.amount*(10**campaign.decimals)));
    const tx = new web3.Transaction().add(...instructions);
    const sig = await provider.signAndSendTransaction(tx);
    log(logEl, `Claimed ${campaign.amount} tokens | Tx: ${sig}`);
  }catch(e){ log(logEl, `Error: ${e.message}`); }
};
</script>
</body>
</html>

