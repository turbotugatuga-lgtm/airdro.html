<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TurboTuga Mass Sender</title>
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@0.4.6/lib/index.iife.js"></script>
</head>
<body style="font-family:sans-serif;padding:20px;">
  <h2>🚀 TurboTuga - Mass Send</h2>

  <button id="connectBtn">Connect Wallet</button>
  <button id="disconnectBtn" style="display:none;">Disconnect</button>
  <p id="walletInfo"></p>

  <h3>Mass Send Options</h3>
  <label>Mint Address:<br><input id="mint" style="width:400px"></label><br>
  <label>Decimals:<br><input id="decimals" type="number" value="6"></label><br>
  <label>Amount Each:<br><input id="amountEach" type="number" value="1"></label><br><br>

  <label>Paste Destinations:<br>
    <textarea id="destinations" rows="6" cols="50"></textarea>
  </label><br>
  <label>Or Upload File:<br>
    <input type="file" id="fileInput">
  </label><br><br>

  <h4>Choose Service Fee</h4>
  <label><input type="radio" name="feeType" value="fixed" checked> Fixed 0.1 SOL</label><br>
  <label><input type="radio" name="feeType" value="per"> Variable 0.00005 SOL per wallet</label><br><br>

  <button id="calcBtn">Calculate Costs</button>
  <pre id="calcLog"></pre>

  <button id="sendBtn" disabled>Send Tokens</button>
  <pre id="log"></pre>

<script>
const TREASURY = "9Sexip38yhfeZD2EBDQkVRicZSY6eSK3cXxgDkgFVf8b"; // sua wallet oculta no código
const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("devnet"));
let walletPubkey = null;
let provider = null;

// --- Connect / Disconnect ---
document.getElementById("connectBtn").onclick = async ()=>{
  try{
    const resp = await window.solana.connect();
    walletPubkey = resp.publicKey;
    provider = window.solana;
    document.getElementById("walletInfo").innerText = "Connected: "+walletPubkey.toString();
    document.getElementById("connectBtn").style.display="none";
    document.getElementById("disconnectBtn").style.display="inline";
  }catch(e){ alert("Wallet connect error: "+e.message); }
};
document.getElementById("disconnectBtn").onclick = async ()=>{
  await window.solana.disconnect();
  walletPubkey = null; provider = null;
  document.getElementById("walletInfo").innerText = "";
  document.getElementById("connectBtn").style.display="inline";
  document.getElementById("disconnectBtn").style.display="none";
};

// --- File Upload ---
document.getElementById("fileInput").addEventListener("change",async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const text = await file.text();
  document.getElementById("destinations").value = text.trim();
});

// --- Calculate Costs ---
document.getElementById("calcBtn").onclick = async ()=>{
  const mint = document.getElementById("mint").value.trim();
  const decimals = parseInt(document.getElementById("decimals").value);
  const amount = parseFloat(document.getElementById("amountEach").value);
  const dests = document.getElementById("destinations").value.trim().split("\n").filter(x=>x);
  const logEl = document.getElementById("calcLog");
  logEl.textContent = "";

  if(!walletPubkey){ logEl.textContent="Connect wallet first"; return; }
  if(!mint || !amount || dests.length===0){ logEl.textContent="Fill all fields"; return; }

  // --- Fee calc ---
  let feeType = document.querySelector('input[name="feeType"]:checked').value;
  let serviceFee = (feeType==="fixed") ? 0.1 : (0.00005 * dests.length);
  serviceFee = parseFloat(serviceFee.toFixed(6));

  const balance = await connection.getBalance(walletPubkey);
  const solBalance = balance/solanaWeb3.LAMPORTS_PER_SOL;

  logEl.textContent += `Wallet balance: ${solBalance} SOL\n`;
  logEl.textContent += `Recipients: ${dests.length}\n`;
  logEl.textContent += `Token each: ${amount}\n`;
  logEl.textContent += `Service Fee: ${serviceFee} SOL\n`;
  logEl.textContent += `+ Network fee (≈0.00001 SOL per tx)\n`;

  if(solBalance < serviceFee+0.001){
    logEl.textContent += "\n❌ Not enough SOL for fees";
    document.getElementById("sendBtn").disabled=true;
  }else{
    logEl.textContent += "\n✅ Ready to send";
    document.getElementById("sendBtn").disabled=false;
  }
};

// --- Mass Send ---
document.getElementById("sendBtn").onclick = async ()=>{
  const logEl = document.getElementById("log");
  logEl.textContent="";

  const mint = document.getElementById("mint").value.trim();
  const decimals = parseInt(document.getElementById("decimals").value);
  const amount = parseFloat(document.getElementById("amountEach").value);
  const dests = document.getElementById("destinations").value.trim().split("\n").filter(x=>x);

  // pick fee
  let feeType = document.querySelector('input[name="feeType"]:checked').value;
  let serviceFee = (feeType==="fixed") ? 0.1 : (0.00005 * dests.length);
  serviceFee = parseFloat(serviceFee.toFixed(6));

  try{
    // 1. Pay service fee to treasury
    const txFee = new solanaWeb3.Transaction().add(
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: walletPubkey,
        toPubkey: new solanaWeb3.PublicKey(TREASURY),
        lamports: serviceFee*solanaWeb3.LAMPORTS_PER_SOL
      })
    );
    let sigFee = await provider.signAndSendTransaction(txFee);
    logEl.textContent += `Service fee paid: ${sigFee.signature}\n`;

    // 2. Send tokens (simplificado para exemplo)
    const mintPub = new solanaWeb3.PublicKey(mint);
    const ataSender = await splToken.getAssociatedTokenAddress(mintPub, walletPubkey);

    for(const dest of dests){
      try{
        const destPub = new solanaWeb3.PublicKey(dest);
        const ataDest = await splToken.getAssociatedTokenAddress(mintPub, destPub);
        const instructions = [];
        const info = await connection.getAccountInfo(ataDest);
        if(!info) instructions.push(splToken.createAssociatedTokenAccountInstruction(walletPubkey, ataDest, destPub, mintPub));
        const transferIx = splToken.createTransferInstruction(ataSender, ataDest, walletPubkey, amount*(10**decimals));
        instructions.push(transferIx);

        const tx = new solanaWeb3.Transaction().add(...instructions);
        const sig = await provider.signAndSendTransaction(tx);
        logEl.textContent += `Sent to ${dest}: ${sig.signature}\n`;
      }catch(e){ logEl.textContent += `Error to ${dest}: ${e.message}\n`; }
    }
  }catch(e){ logEl.textContent += "Global error: "+e.message; }
};
</script>
</body>
</html>
